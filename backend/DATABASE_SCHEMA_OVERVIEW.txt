================================================================================
DATABASE SCHEMA OVERVIEW - NABAVKIDATA.COM
================================================================================

Created: 2025-11-23
Migration: 20251123_220000
Tables: 31 total (22 required + 9 supporting)

================================================================================
TABLE RELATIONSHIPS
================================================================================

USERS & AUTHENTICATION
======================
┌─────────────────┐
│     users       │ (Primary user accounts)
└────────┬────────┘
         │
         ├─── refresh_tokens (1:many) - JWT refresh tokens
         ├─── api_keys (1:many) - API authentication
         ├─── user_preferences (1:1) - User settings
         ├─── personalization_settings (1:1) - Dashboard customization
         ├─── subscriptions (1:many) - Stripe subscriptions
         ├─── query_history (1:many) - AI queries
         ├─── analysis_history (1:many) - AI analysis
         ├─── alerts (1:many) - Custom alerts
         ├─── notifications (1:many) - In-app notifications
         ├─── saved_searches (1:many) - Saved queries
         ├─── message_threads (1:many) - Support tickets
         ├─── usage_tracking (1:many) - Activity logs
         ├─── audit_log (1:many) - Security audit
         └─── organizations (many:1) - Company membership

TENDERS & DOCUMENTS
===================
┌──────────────────┐
│     tenders      │ (Core tender data)
└────────┬─────────┘
         │
         ├─── tender_documents (1:many) - PDFs and files
         │    └─── embeddings (1:many) - Vector search
         │
         ├─── documents (1:many) - Alias for compatibility
         │
         ├─── tender_entity_link (many:many) - Entity relationships
         │
         ├─── notifications (1:many) - Tender alerts
         │
         └─── analysis_history (1:many) - AI analysis

SUBSCRIPTIONS & BILLING
========================
┌────────────────────┐
│   subscriptions    │
└────────┬───────────┘
         │
         ├─── subscription_usage (1:many) - Resource tracking
         └─── billing_events (1:many) - Payment events

MESSAGING SYSTEM
================
┌────────────────────┐
│  message_threads   │
└────────┬───────────┘
         │
         └─── messages (1:many) - Thread messages

REFERENCE DATA
==============
┌─────────────────┐      ┌──────────────────┐
│   cpv_codes     │      │ entity_categories│
└─────────────────┘      └──────────────────┘
  (Hierarchical)           (Hierarchical)
  Self-referencing         Self-referencing

ADMIN & SECURITY
================
┌──────────────────┐    ┌─────────────────┐    ┌──────────────┐
│  admin_settings  │    │ admin_audit_log │    │fraud_events  │
└──────────────────┘    └─────────────────┘    └──────────────┘

SYSTEM
======
┌──────────────────┐    ┌─────────────────┐
│  system_config   │    │  rate_limits    │
└──────────────────┘    └─────────────────┘

================================================================================
TABLE DETAILS
================================================================================

Core Tables (6)
===============
users                   - User accounts & authentication
organizations          - Company/organization entities
tenders                - Public procurement tenders
tender_documents       - PDF documents and attachments
embeddings             - Vector embeddings for AI/RAG
subscriptions          - Stripe subscription management

Authentication (4)
==================
refresh_tokens         - JWT refresh token storage
api_keys              - API key management
user_preferences      - User account settings
personalization_settings - Dashboard customization

Billing (2)
===========
billing_events        - Stripe webhook events
subscription_usage    - Resource usage tracking

Notifications (3)
=================
alerts                - User-defined alert configs
notifications         - In-app and email notifications
saved_searches        - Saved search queries

Messaging (2)
=============
message_threads       - Support conversation threads
messages             - Individual thread messages

AI & Analytics (2)
==================
query_history        - AI assistant queries
analysis_history     - ML/AI analysis results

Reference Data (3)
==================
cpv_codes           - Common Procurement Vocabulary
entity_categories   - Tender categorization taxonomy
tender_entity_link  - Many-to-many tender relationships

Tracking & Audit (4)
====================
usage_tracking      - General usage analytics
audit_log          - Security audit trail
admin_audit_log    - Admin action logging
fraud_events       - Fraud detection events

Configuration (3)
=================
admin_settings     - Admin configuration
system_config      - System key-value store
rate_limits        - API rate limiting (fraud prevention)

Compatibility (2)
=================
documents          - Alias for tender_documents
fraud_detection    - Fraud prevention (previous migration)

================================================================================
INDEX SUMMARY
================================================================================

Total Indexes: 85+

Categories:
- Primary Keys: 29 (all tables)
- Foreign Keys: 35+
- Status/Flags: 10 (is_active, is_read, status, etc.)
- Timestamps: 8 (created_at, expires_at, etc.)
- Business Logic: 20+ (email, categories, codes, etc.)
- Unique Constraints: 8 (emails, tokens, stripe IDs)

Performance Optimizations:
- All foreign keys indexed
- Search fields indexed (email, categories, CPV codes)
- Status fields indexed for filtering
- Timestamp fields indexed for date ranges
- JSONB fields for flexible schema evolution

================================================================================
FOREIGN KEY CASCADE BEHAVIOR
================================================================================

CASCADE DELETE (Child deleted when parent deleted)
===================================================
- All user-owned data (preferences, api_keys, alerts, etc.)
- All tender-related data (documents, embeddings, notifications)
- All subscription data (usage, billing events)
- All message threads and messages
- All entity links

SET NULL (Child preserved, reference nullified)
===============================================
- Query history (preserve queries if user deleted)
- Analysis history (preserve for analytics)
- Audit logs (preserve for compliance)
- Billing events (preserve for accounting)
- Fraud events (preserve for investigation)

================================================================================
DATA TYPES
================================================================================

PostgreSQL-Specific:
- UUID: All primary keys and most foreign keys
- JSONB: Metadata, filters, settings, results
- INET: IP addresses
- ARRAY(Float): Vector embeddings (convert to pgvector)

Standard Types:
- VARCHAR: String fields with limits
- TEXT: Unlimited text content
- INTEGER: Counts, IDs, durations (milliseconds)
- NUMERIC: Money (15,2), confidence scores (3,2)
- Boolean: Flags and status
- Date: Calendar dates
- DateTime: Timestamps with timezone

================================================================================
POST-MIGRATION TASKS
================================================================================

Required:
1. Convert embeddings.vector to pgvector type
2. Create vector index (ivfflat)

Recommended:
3. Import CPV code master data
4. Populate system_config defaults
5. Create materialized views for analytics

Optional:
6. Set up automated refresh for materialized views
7. Configure full-text search indexes
8. Set up partitioning for large tables (usage_tracking, audit_log)

================================================================================
FILES CREATED
================================================================================

Migration:
- alembic/versions/20251123_220000_create_missing_tables.py (32 KB)

Configuration:
- alembic.ini (3.5 KB)
- alembic/env.py (2.5 KB)

Scripts:
- run_migration.sh (3.3 KB) - Migration runner
- validate_migration.py (3.4 KB) - Validation tool

Documentation:
- MIGRATION_SUMMARY.md (18 KB) - Complete documentation
- MIGRATION_QUICK_START.md (5.4 KB) - Quick reference
- DELIVERABLES_CHECKLIST.md (8 KB) - Deliverables inventory
- DATABASE_SCHEMA_OVERVIEW.txt (This file)

================================================================================
STATUS: ✅ READY FOR DEPLOYMENT
================================================================================

Coverage: 22/22 (100%) audit-required tables
Total: 31 tables
Indexes: 85+
Foreign Keys: 35+
Documentation: Complete
Validation: Passed

Next: Test in staging environment

================================================================================
